<!-- A bdec specification of the pdf file format.

    See http://www.adobe.com/devnet/pdf/pdf_reference.html for information from
    Adobe on the file format.
    -->
<protocol>
    <common>
        <choice name="end of line">
            <sequence name="lf cr:">
                <field name="cr:" length="8" value="0xd" />
                <field name="lf:" length="8" value="0xa" />
            </sequence>
            <field name="cr:" length="8" value="0xd" />
            <field name="lf:" length="8" value="0xa" />
        </choice>

        <choice name="non breaking whitespace:">
            <field name="tab" length="8" value="0x09" />
            <field name="space" length="8" value="0x20" />
        </choice>

        <choice name="other whitespace:">
            <field name="null" length="8" value="0x00" />
            <field name="form feed" length="8" value="0x0c" />
        </choice>

        <choice name="whitespace entry:">
            <reference name="end of line" />
            <reference name="non breaking whitespace:" />
            <reference name="other whitespace:" />
        </choice>

        <sequenceof name="optional whitespace:">
            <choice name="entry:">
                <reference name="whitespace entry:" />
                <field name="end:" length="0"><end-sequenceof /> </field>
            </choice>
        </sequenceof>

        <sequence name="whitespace">
            <reference name="whitespace entry:" />
            <reference name="optional whitespace:" />
        </sequence>

        <sequence name="header">
            <field name="id:" length="40" value="0x255044462d" />
            <field name="version" length="24" type="text" value="0x312e33" />
            <reference name="end of line" />
        </sequence>

        <sequence name="comment">
            <field name="id:" length="8" value="0x25" />
            <sequenceof name="text">
                <choice name="entry:">
                    <reference name="end of line"><end-sequenceof /></reference>
                    <field name="char" length="8" type="hex" />
                </choice>
            </sequenceof>
        </sequence>

        <sequence name="name">
            <sequenceof name="chars">
                <choice name="entry:">
                    <!-- We don't include the '<' or '>' characters -->
                    <field name="char" length="8" type="text" min="33" max="60" />
                    <field name="char" length="8" type="text" min="61" max="61" />
                    <field name="char" length="8" type="text" min="63" />
                    <field name="empty:" length="0"><end-sequenceof /></field>
                </choice>
            </sequenceof>
        </sequence>

        <sequence name="name object">
            <field name="id:" length="8" value="0x2f" />
            <reference name="name" />
        </sequence>

        <sequence name="integer">
            <choice name="sign:">
                <field name="positive" length="8" value="0x2b" />
                <field name="negative" length="8" value="0x2d" />
                <field name="none:" length="0" />
            </choice>
            <field name="number" length="8" type="text" min="48" max="57" />
            <sequenceof name="number:">
                <choice name="char:">
                    <field name="number" length="8" type="text" min="48" max="57" />
                    <field name="none" length="0"><end-sequenceof /></field>
                </choice>
            </sequenceof>
        </sequence>

        <sequence name="object reference">
            <sequence name="object number">
                <reference name="integer" />
            </sequence>
            <reference name="non breaking whitespace:" />
            <sequence name="generation number">
                <reference name="integer" />
            </sequence>
            <reference name="non breaking whitespace:" />
            <field name="id:" length="8" value="0x52" />
        </sequence>

        <sequence name="dictionary object">
            <field name="opener:" length="16" value="0x3c3c" />
            <sequenceof name="entries:">
                <choice name="entry:">
                    <field name="closer:" length="16" value="0x3e3e" ><end-sequenceof /></field>
                    <sequence name="entry">
                        <reference name="name object" />
                        <reference name="whitespace" />
                        <reference name="object:" />
                    </sequence>
                </choice>
            </sequenceof>
        </sequence>

        <sequence name="indirect object">
            <sequence name="object number">
                <reference name="integer" />
            </sequence>
            <reference name="whitespace" />
            <sequence name="generation number">
                <reference name="integer" />
            </sequence>
            <reference name="whitespace" />
            <reference name="name" />
            <reference name="whitespace" />
            <reference name="object:" />
            <reference name="whitespace" />
            <field name="endobj:" length="48" value="0x656e646f626a" />
        </sequence>

        <sequence name="stream object">
            <reference name="dictionary object" />
            <reference name="whitespace" />
            <field name="stream:" length="48" value="0x73747265616d" />
            <reference name="end of line" />
            <!-- A programmatic decoder would look in the previous dictionary
                object for the 'length' entry; that option isn't avaiable to 
                us. We'll just decode until we get 'endstream' (and hope that
                text isn't in the binary data)...
                 -->
             <sequenceof name="data">
                 <choice name="entry:">
                     <field name="endstream" length="72" value="0x656e6473747265616d" ><end-sequenceof/></field>
                     <field name="byte" length="8" type="hex" />
                 </choice>
             </sequenceof>
        </sequence>

        <sequence name="array object">
            <field name="open square bracket:" length="8" value="0x5b" />
            <sequenceof name="objects:">
                <choice name="array entry:">
                    <field name="close square bracket:" length="8" value="0x5d" ><end-sequenceof /></field>
                    <reference name="object:" />
                </choice>
            </sequenceof>
        </sequence>

        <sequence name="object:">
            <reference name="optional whitespace:" />
            <choice name="object entry:">
                <reference name="comment" />
                <reference name="object reference" />
                <reference name="indirect object" />
                <reference name="name object" />
                <reference name="stream object" />
                <reference name="dictionary object" />
                <reference name="array object" />
                <reference name="integer" />
            </choice>
        </sequence>

        <sequence name="body">
            <sequenceof name="objects">
                <reference name="object:" />
            </sequenceof>
        </sequence>
    </common>

    <sequence name="pdf">
        <reference name="header" />
        <reference name="body" />
    </sequence>
</protocol>
