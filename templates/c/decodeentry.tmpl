## vim:set syntax=mako:
<%namespace file="/expression.tmpl" name="expr" />
<%!
    from bdec.field import Field
    from bdec.sequence import Sequence
%>

<%def name="decodeFieldValue(entry, variable)">
  %if entry.format is Field.INTEGER:
    %if entry.encoding is Field.BIG_ENDIAN:
    ${variable} = decode_integer(buffer, ${expr.length(entry)});
    %else:
    ${variable} = decode_little_endian_integer(buffer, ${expr.length(entry)});
    %endif
  %elif entry.format is Field.TEXT:
    int i;
    int ${entry.name}_length = ${expr.length(entry)} / 8;
    ${variable} = malloc(${entry.name}_length + 1);
    ${variable}[${entry.name}_length] = 0;
    for (i = 0; i < ${entry.name}_length; ++i)
    {
        ${variable}[i] = decode_integer(buffer, 8);
    }
  %elif entry.format is Field.HEX:
    int i;
    ${variable}.length = ${expr.length(entry)} / 8;
    ${variable}.buffer = malloc(${variable}.length);
    for (i = 0; i < ${variable}.length; ++i)
    {
        ${variable}.buffer[i] = decode_integer(buffer, 8);
    }
  %elif entry.format is Field.BINARY:
    #error Binary field type not supported yet...
  %else:
    #error Unknown field type ${entry}
  %endif
</%def>

<%def name="decodeField(entry, variable)">
    if ((buffer->end - buffer->buffer) * 8 < ${expr.length(entry)})
    {
        return 0;
    }
    ${decodeFieldValue(entry, variable)}
     %if entry.expected is not None:
    if (${variable} != ${int(entry.expected)})
    {
        return 0;
    }
     %endif
</%def>

<%def name="decodeSequence(entry)">
  %for child in entry.children:
    %if isinstance(child, Field):
    ${decodeField(child, 'result->' + child.name)}
    %else:
    if (!decode_${child.name}(buffer, &result->${child.name}))
    {
        return 0;
    }
    %endif
  %endfor
</%def>
